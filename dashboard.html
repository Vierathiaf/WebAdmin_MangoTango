<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
</head>
<body>
  <div class="layout">
    <!-- Sidebar -->
    <div class="sidebar">
      <a href="admin-profile.html" class="admin-info" style="text-decoration: none; color: inherit; cursor: pointer;">
        <img src="images/profile.png" alt="Profile" class="icon">
        <span>MangoTango Admin</span>
      </a>

      <a href="dashboard.html" class="sidebar-link">
        <img src="images/home.png" alt="Dashboard" class="icon">
        <span>Dashboard</span>
      </a>

      <a href="pending.html" class="sidebar-link">
        <img src="images/users.png" alt="Registered Accounts" class="icon">
        <span>Pending Accounts</span>
      </a>

      <a href="approval.html" class="sidebar-link">
        <img src="images/approve.png" alt="Account Approval Panel" class="icon">
        <span>Account Approval Panel</span>
      </a>

      <a href="admin-login.html" class="sidebar-link logout-link">
        <img src="images/logout-ic.png" alt="Logout" class="icon">
        <span>Logout</span>
      </a>
    </div>

    <!-- Main Content -->
    <div class="content">
      <div class="content-header">
        <h1>Dashboard</h1>
        <div class="notif-container">
          <button class="notif-bell" aria-label="Notifications">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
            <span class="notif-badge" hidden>0</span>
          </button>
          <div class="notif-panel" hidden>
            <div class="notif-header">Notifications</div>
            <ul class="notif-list"></ul>
          </div>
        </div>
      </div>

      <div class="stats">
        <div class="card card-registered">
          <div class="card-icon">üë•</div>
          <h3>Registered Technicians</h3>
          <p class="number" id="registeredCount">0</p>
          <small>Active technicians in system</small>
        </div>
        <a href="approval.html" class="card card-pending">
          <div class="card-icon">‚è≥</div>
          <h3>Pending Approvals</h3>
          <p class="number" id="pendingCount">0</p>
          <small>Awaiting admin review</small>
        </a>
      </div>

      <!-- Enhanced Analytics Dashboard -->
      <div class="analytics-section">
        <div class="analytics-header">
          <h2>üìà Analytics Dashboard</h2>
          <div class="analytics-controls">
            <select id="timeRange" class="time-selector">
              <option value="7">Last 7 Days</option>
              <option value="30" selected>Last 30 Days</option>
              <option value="90">Last 90 Days</option>
            </select>
          </div>
        </div>

        <div class="analytics-grid">
          <!-- Registration trends Chart -->
          <div class="chart-container full-width">
            <div class="chart-header">
              <h3>üöÄ Registration Trends</h3>
              <span class="chart-subtitle">Daily new technician registrations</span>
            </div>
            <canvas id="registrationsChart"></canvas>
            <div class="chart-stats">
              <div class="stat-item">
                <span class="stat-value" id="totalRegistrations">0</span>
                <span class="stat-label">Total Registrations</span>
              </div>
              <div class="stat-item">
                <span class="stat-value" id="avgDaily">0</span>
                <span class="stat-label">Daily Average</span>
              </div>
            </div>
          </div>

          <!-- Status Distribution and Recent Activity Row -->
          <div class="analytics-row">
            <!-- Status Distribution Chart -->
            <div class="chart-container half-width">
              <div class="chart-header">
                <h3>üìä Status Distribution</h3>
                <span class="chart-subtitle">Approval status breakdown</span>
              </div>
              <canvas id="statusChart"></canvas>
              <div class="status-legend">
                <div class="legend-item">
                  <span class="legend-color approved"></span>
                  <span>Approved</span>
                </div>
                <div class="legend-item">
                  <span class="legend-color pending"></span>
                  <span>Pending</span>
                </div>
                <div class="legend-item">
                  <span class="legend-color rejected"></span>
                  <span>Rejected</span>
                </div>
              </div>
            </div>

            <!-- Activity Timeline -->
            <div class="chart-container half-width">
              <div class="chart-header">
                <h3>‚ö° Recent Activity</h3>
                <span class="chart-subtitle">Real-time updates</span>
              </div>
              <div class="activity-timeline" id="activityTimeline">
                <div class="activity-item" style="text-align: center; color: #718096; padding: 40px 20px;">
                  <div class="activity-content">
                    <div class="activity-desc">Loading activity...</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module">
    import { db, auth } from "./firebase-config.js";
    import { collection, onSnapshot }
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { signOut, onAuthStateChanged } 
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { initNotifications } from "./notifications.js";

    onAuthStateChanged(auth, (user) => {
      if (!user || user.email !== "mangotangodev.ph@gmail.com") {
        window.location.href = "admin-login.html";
      }
    });

    document.querySelector(".logout-link").addEventListener("click", async (e) => {
      e.preventDefault();
      await signOut(auth);
      window.location.replace("admin-login.html");
    });

    function loadStats() {
      const expertsRef = collection(db, "technician");

      onSnapshot(expertsRef, (snapshot) => {
        console.log("Dashboard: Received snapshot with", snapshot.size, "documents");
        let approvedCount = 0;
        let pendingCount = 0;
        let rejectedCount = 0;
        const monthCounts = {};
        const activities = [];

        snapshot.forEach(doc => {
          const data = doc.data();
          console.log("Dashboard: Document data:", data);
          if (data.status === "Approved") {
            approvedCount++;
          } else if (data.status === "Pending") {
            pendingCount++;
          } else if (data.status === "Rejected") {
            rejectedCount++;
          }

          let dateObj = null;
          if (data.createdAt && typeof data.createdAt.toDate === 'function') {
            dateObj = data.createdAt.toDate();
          } else if (data.registrationDate) {
            const parts = String(data.registrationDate).split('-');
            if (parts.length === 3) {
              dateObj = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
            }
          }
          if (dateObj) {
            const month = dateObj.toLocaleString("default", { month: "short" });
            monthCounts[month] = (monthCounts[month] || 0) + 1;
            
            // Collect activity data
            let action = 'New Registration';
            if (data.status === 'Approved') {
              action = 'Technician Approved';
            } else if (data.status === 'Rejected') {
              action = 'Technician Rejected';
            }
            
            activities.push({
              name: `${data.firstName || 'Unknown'} ${data.lastName || 'User'}`,
              expertise: data.expertise || 'Technician',
              status: data.status || 'Pending',
              timestamp: dateObj,
              action: action
            });
          }
        });

        console.log("Dashboard: Counts - Approved:", approvedCount, "Pending:", pendingCount, "Rejected:", rejectedCount);
        document.getElementById("registeredCount").textContent = approvedCount;
        document.getElementById("pendingCount").textContent = pendingCount;

        const labels = Object.keys(monthCounts);
        const dataPoints = Object.values(monthCounts);
        const totalRegistrations = approvedCount + pendingCount + rejectedCount;
        
        renderRegistrationsChart(labels, dataPoints);
        renderStatusChart(approvedCount, pendingCount, rejectedCount);
        updateAnalyticsStats(approvedCount, pendingCount, totalRegistrations);
        updateActivityTimeline(activities);
      }, (error) => {
        console.error("Dashboard: Error fetching data:", error);
      });
    }

    let registrationsChart = null;
    let statusChart = null;

    function renderRegistrationsChart(labels, dataPoints) {
      const ctx = document.getElementById('registrationsChart').getContext('2d');
      
      if (registrationsChart) {
        registrationsChart.destroy();
      }
      
      registrationsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'New Registrations',
            data: dataPoints,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#667eea',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 6,
            pointHoverRadius: 8,
            pointHoverBackgroundColor: '#764ba2',
            pointHoverBorderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { 
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(102, 126, 234, 0.9)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: '#667eea',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: false
            }
          },
          scales: {
            y: { 
              beginAtZero: true,
              grid: {
                color: 'rgba(102, 126, 234, 0.1)',
                drawBorder: false
              },
              ticks: {
                color: '#718096',
                font: {
                  family: 'Segoe UI, sans-serif',
                  size: 12
                },
                padding: 10
              }
            },
            x: { 
              grid: { 
                display: false,
                drawBorder: false
              },
              ticks: {
                color: '#718096',
                font: {
                  family: 'Segoe UI, sans-serif',
                  size: 12
                },
                padding: 10
              }
            }
          },
          elements: {
            point: {
              hoverRadius: 8
            }
          }
        }
      });
    }

    function renderStatusChart(approvedCount, pendingCount, rejectedCount = 0) {
      const ctx = document.getElementById('statusChart').getContext('2d');
      
      if (statusChart) {
        statusChart.destroy();
      }
      
      statusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Approved', 'Pending', 'Rejected'],
          datasets: [{
            data: [approvedCount, pendingCount, rejectedCount],
            backgroundColor: [
              '#48bb78',
              '#ed8936', 
              '#f56565'
            ],
            hoverBackgroundColor: [
              '#38a169',
              '#dd6b20',
              '#e53e3e'
            ],
            borderWidth: 0,
            hoverOffset: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(45, 55, 72, 0.9)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: '#667eea',
              borderWidth: 1,
              cornerRadius: 8,
              callbacks: {
                label: function(context) {
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((context.parsed / total) * 100).toFixed(1);
                  return `${context.label}: ${context.parsed} (${percentage}%)`;
                }
              }
            }
          },
          cutout: '60%'
        }
      });
    }

    function updateAnalyticsStats(approvedCount, pendingCount, totalRegistrations) {
      document.getElementById('totalRegistrations').textContent = totalRegistrations;
      document.getElementById('avgDaily').textContent = Math.round(totalRegistrations / 30);
    }

    function updateActivityTimeline(activities) {
      const timeline = document.getElementById('activityTimeline');
      
      // Sort activities by timestamp (most recent first)
      activities.sort((a, b) => b.timestamp - a.timestamp);
      
      // Take only the 10 most recent activities
      const recentActivities = activities.slice(0, 10);
      
      if (recentActivities.length === 0) {
        timeline.innerHTML = `
          <div class="activity-item" style="text-align: center; color: #718096; padding: 40px 20px;">
            <div class="activity-content">
              <div class="activity-desc">No activity yet</div>
            </div>
          </div>
        `;
        return;
      }
      
      timeline.innerHTML = recentActivities.map(activity => {
        const timeAgo = getTimeAgo(activity.timestamp);
        let iconClass, icon;
        
        if (activity.status === 'Approved') {
          iconClass = 'approved';
          icon = '‚úÖ';
        } else if (activity.status === 'Rejected') {
          iconClass = 'rejected';
          icon = '‚ùå';
        } else {
          iconClass = 'pending';
          icon = '‚è≥';
        }
        
        return `
          <div class="activity-item">
            <div class="activity-icon ${iconClass}">${icon}</div>
            <div class="activity-content">
              <div class="activity-title">${activity.action}</div>
              <div class="activity-desc">${activity.name} - ${activity.expertise}</div>
              <div class="activity-time">${timeAgo}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function getTimeAgo(timestamp) {
      const now = new Date();
      const diff = now - timestamp;
      const seconds = Math.floor(diff / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);
      
      if (seconds < 60) return 'Just now';
      if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
      if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
      if (days < 7) return `${days} day${days > 1 ? 's' : ''} ago`;
      if (days < 30) return `${Math.floor(days / 7)} week${Math.floor(days / 7) > 1 ? 's' : ''} ago`;
      return `${Math.floor(days / 30)} month${Math.floor(days / 30) > 1 ? 's' : ''} ago`;
    }

    // Test function to verify Firestore data fetching
    async function testFirestoreData() {
      try {
        console.log('üîç Testing Firestore data fetching...');
        
        const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
        const technicianRef = collection(db, "technician");
        const snapshot = await getDocs(technicianRef);
        
        console.log(`üìä Found ${snapshot.size} technician records in Firestore`);
        
        snapshot.forEach(doc => {
          const data = doc.data();
          console.log(`üë§ Technician ID: ${doc.id}`);
          console.log(`üìß Email: ${data.email || 'NO EMAIL'}`);
          console.log(`üë§ Name: ${data.firstName || 'NO FIRST NAME'} ${data.lastName || 'NO LAST NAME'}`);
          console.log(`üìã Status: ${data.status || 'NO STATUS'}`);
          console.log(`üîß Expertise: ${data.expertise || 'NO EXPERTISE'}`);
          console.log('üìÑ Full data:', data);
          console.log('---');
        });
        
        return snapshot.size;
        
      } catch (error) {
        console.error('‚ùå Error testing Firestore data:', error);
        return 0;
      }
    }
    
    // Make test function globally available
    window.testFirestoreData = testFirestoreData;

    window.addEventListener('DOMContentLoaded', async () => {
      onAuthStateChanged(auth, async (user) => {
        if (user && user.email === "mangotangodev.ph@gmail.com") {
          await Promise.all([loadStats(), initNotifications(db)]);
        }
      });
    });

    window.addEventListener('popstate', () => {
      if (!auth.currentUser) {
        window.location.replace('admin-login.html');
      }
    });
  </script>
</body>
</html>