<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Technician Review</title>
  <link rel="stylesheet" href="styles.css">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
</head>

<body>
  <div class="layout">
    <!-- Sidebar -->
    <div class="sidebar">
      <a href="admin-profile.html" class="admin-info" style="text-decoration: none; color: inherit; cursor: pointer;">
        <img src="images/profile.png" alt="Profile" class="icon">
        <span>MangoTango Admin</span>
      </a>

      <a href="dashboard.html" class="sidebar-link">
        <img src="images/home.png" alt="Dashboard" class="icon">
        <span>Dashboard</span>
      </a>

      <a href="pending.html" class="sidebar-link">
        <img src="images/users.png" alt="Registered Accounts" class="icon">
        <span>Pending Accounts</span>
      </a>

      <a href="approval.html" class="sidebar-link">
        <img src="images/approve.png" alt="Account Approval Panel" class="icon">
        <span>Account Approval Panel</span>
      </a>

      <a href="admin-login.html" class="sidebar-link logout-link">
        <img src="images/logout-ic.png" alt="Logout" class="icon">
        <span>Logout</span>
      </a>
    </div>

    <!-- Main Content -->
    <div class="content">
      <div class="content-header">
        <h1>Technician Review</h1>
        <div class="notif-container">
          <button class="notif-bell" aria-label="Notifications">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
            <span class="notif-badge" hidden>0</span>
          </button>
          <div class="notif-panel" hidden>
            <div class="notif-header">Notifications</div>
            <ul class="notif-list"></ul>
          </div>
        </div>
      </div>

      <div class="container review-panel">
        <h2>Review Technician Registration</h2>

        <div class="review-grid">
          <div class="info-column">
            <h3>Technician Details</h3>
            <div class="info-group">
              <label>First Name</label>
              <div class="input-box" id="firstNameBox">Loading...</div>
            </div>
            <div class="info-group">
              <label>Last Name</label>
              <div class="input-box" id="lastNameBox">Loading...</div>
            </div>
            <div class="info-group">
              <label>Email</label>
              <div class="input-box" id="emailBox">Loading...</div>
            </div>
            <div class="info-group">
              <label>Role/Expertise</label>
              <div class="input-box" id="expertiseBox">Loading...</div>
            </div>
            <div class="info-group">
              <label>Department Address</label>
              <div class="input-box" id="addressBox">Loading...</div>
            </div>
          </div>
          <div class="certificate-column">
            <h3>Certificate</h3>
            <div class="certificate-box">
              <div id="certificateContainer">
                <img id="certificatePreview" src="images/certificate.png" alt="Certificate"
                  style="cursor:pointer; max-width: 100%; height: auto; border-radius: 8px; border: 2px solid #e5e7eb;">
                <div id="certificateLoading" style="display: none; text-align: center; padding: 20px;">
                  <div class="loading-spinner"></div>
                  <p>Loading certificate...</p>
                </div>
                <div id="certificateError" style="display: none; text-align: center; padding: 20px; color: #ef4444;">
                  <p>‚ùå Certificate not available</p>
                </div>
              </div>
              <div class="certificate-actions" style="margin-top: 10px; display: flex; gap: 10px;">
                <button id="viewFullScreen" class="btn-secondary" style="display: none;">üîç View Full Screen</button>
                <button id="downloadCertificate" class="btn-secondary" style="display: none;">üì• Download</button>
              </div>
            </div>
          </div>
        </div>

        <div class="buttons">
          <button id="approveBtn" class="approve">‚úÖ Approve</button>
          <button id="rejectBtn" class="reject">‚ùå Reject</button>
        </div>
      </div>
    </div>

    <div id="certificateModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Certificate - Full View</h3>
          <button class="modal-close" id="closeModal">&times;</button>
        </div>
        <div class="modal-body">
          <img id="modalCertificateImage" src="" alt="Certificate Full View"
            style="max-width: 100%; max-height: 80vh; object-fit: contain;">
        </div>
        <div class="modal-footer">
          <button id="modalDownload" class="btn-primary">üì• Download Certificate</button>
          <button id="modalClose" class="btn-secondary">Close</button>
        </div>
      </div>
    </div>

    <script src="firebase-email-service.js"></script>

    <script type="module">
      import { db, auth, rtdb } from "./firebase-config.js";
      import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
      import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
      import { ref, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
      import { initNotifications } from "./notifications.js";

      onAuthStateChanged(auth, (user) => {
        if (!user || user.email !== "mangotangodev.ph@gmail.com") {
          window.location.replace("admin-login.html");
        }
      });

      document.querySelector(".logout-link").addEventListener("click", async (e) => {
        e.preventDefault();
        await signOut(auth);
        window.location.replace("admin-login.html");
      });

      const params = new URLSearchParams(window.location.search);
      const technicianId = params.get("id");

      async function loadCertificateImage(certificateUrl, technicianName) {
        try {
          console.log("üîç Starting certificate load for:", certificateUrl);
          console.log("üîç RTDB instance:", rtdb);

          let imagePath = certificateUrl;
          if (!certificateUrl.startsWith('technician_images/')) {
            imagePath = `technician_images/certificates/${certificateUrl}`;
          }

          console.log("üîç Final image path:", imagePath);

          console.log("üîç Attempting to fetch from RTDB...");
          const snapshot = await get(ref(rtdb, imagePath));
          console.log("üîç Snapshot exists:", snapshot.exists());

          const imageData = snapshot.val();
          console.log("üîç Raw image data:", imageData);
          console.log("üîç Image data type:", typeof imageData);
          console.log("üîç Image data keys:", imageData ? Object.keys(imageData) : 'null');

          if (imageData) {
            if (imageData.base64) {
              console.log("‚úÖ Found base64 in imageData.base64");
              displayCertificate(imageData.base64, technicianName);
              return true;
            } else if (typeof imageData === 'string') {
              console.log("‚úÖ Found base64 as string");
              displayCertificate(imageData, technicianName);
              return true;
            } else if (imageData.data) {
              console.log("‚úÖ Found base64 in imageData.data");
              displayCertificate(imageData.data, technicianName);
              return true;
            } else {
              console.log("‚ùå No base64 data found in any expected field");
              console.log("üîç Available fields:", Object.keys(imageData));
              return false;
            }
          } else {
            console.log("‚ùå No image data retrieved from path:", imagePath);
            return false;
          }
        } catch (error) {
          console.error('‚ùå Certificate loading error:', error);
          console.error('‚ùå Error details:', error.message);
          return false;
        }
      }

      function displayCertificate(base64Data, technicianName) {
        const certificatePreview = document.getElementById("certificatePreview");
        const certificateLoading = document.getElementById("certificateLoading");
        const certificateError = document.getElementById("certificateError");
        const viewFullScreen = document.getElementById("viewFullScreen");
        const downloadCertificate = document.getElementById("downloadCertificate");

        if (certificatePreview) {
          let imageUrl;
          if (base64Data.startsWith('data:')) {
            imageUrl = base64Data;
            console.log("‚úÖ Using base64 data with existing data URL prefix");
          } else {
            imageUrl = `data:image/jpeg;base64,${base64Data}`;
            console.log("‚úÖ Adding data URL prefix to base64 data");
          }

          console.log("‚úÖ Setting certificate image URL:", imageUrl.substring(0, 50) + "...");
          certificatePreview.src = imageUrl;
          window.currentCertificateUrl = imageUrl;

          if (certificateLoading) certificateLoading.style.display = "none";
          if (certificateError) certificateError.style.display = "none";
          if (viewFullScreen) viewFullScreen.style.display = "inline-block";
          if (downloadCertificate) downloadCertificate.style.display = "inline-block";

          console.log("‚úÖ Certificate displayed successfully");
        }
      }

      async function loadTechnician() {
        if (!technicianId) {
          alert("No technician ID provided!");
          window.location.href = "approval.html";
          return;
        }

        try {
          const loadingElements = ['firstNameBox', 'lastNameBox', 'emailBox', 'expertiseBox', 'addressBox'];
          loadingElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.textContent = "Loading...";
          });

          const docRef = doc(db, "technician", technicianId);
          const snapshot = await getDoc(docRef);

          if (snapshot.exists()) {
            const data = snapshot.data();
            console.log("Technician data:", data);

            const firstNameBox = document.getElementById("firstNameBox");
            const lastNameBox = document.getElementById("lastNameBox");
            const emailBox = document.getElementById("emailBox");
            const expertiseBox = document.getElementById("expertiseBox");
            const addressBox = document.getElementById("addressBox");
            const certificatePreview = document.getElementById("certificatePreview");
            const certificateLoading = document.getElementById("certificateLoading");
            const certificateError = document.getElementById("certificateError");
            const viewFullScreen = document.getElementById("viewFullScreen");
            const downloadCertificate = document.getElementById("downloadCertificate");

            if (firstNameBox) firstNameBox.textContent = data.firstName || "N/A";
            if (lastNameBox) lastNameBox.textContent = data.lastName || "N/A";
            if (emailBox) emailBox.textContent = data.email || "N/A";
            if (expertiseBox) expertiseBox.textContent = data.expertise || "N/A";
            if (addressBox) addressBox.textContent = data.address || "N/A";

            console.log("üìã All technician data:", data);
            console.log("üìã Available fields:", Object.keys(data));

            const certificateUrl = data.certificateUrl;
            const technicianName = `${data.firstName || ''} ${data.lastName || ''}`.trim();

            console.log("üìã Certificate URL from Firestore:", certificateUrl);
            console.log("üìã Certificate URL type:", typeof certificateUrl);
            console.log("üìã Technician name:", technicianName);

            if (certificateUrl) {
              console.log("üìã Certificate URL exists, starting load process...");
              if (certificateLoading) certificateLoading.style.display = "block";
              if (certificateError) certificateError.style.display = "none";

              const success = await loadCertificateImage(certificateUrl, technicianName);

              if (!success) {
                console.log("‚ùå Failed to load certificate, showing default");
                if (certificateLoading) certificateLoading.style.display = "none";
                if (certificateError) certificateError.style.display = "block";
                if (certificatePreview) certificatePreview.src = "images/certificate.png";
              }
            } else {
              console.log("‚ùå No certificate URL found in technician data");
              console.log("üìã Checking alternative field names...");

              const altFields = ['certificate', 'certificateImage', 'cert_url', 'imageUrl', 'certificatePath'];
              let foundAlt = false;

              for (const field of altFields) {
                if (data[field]) {
                  console.log(`üìã Found certificate in field '${field}':`, data[field]);
                  foundAlt = true;
                  break;
                }
              }

              if (!foundAlt) {
                console.log("‚ùå No certificate found in any field");
              }

              if (certificatePreview) {
                certificatePreview.src = "images/certificate.png";
                if (certificateError) certificateError.style.display = "block";
              }
            }
          } else {
            alert("Technician not found!");
            window.location.href = "approval.html";
          }
        } catch (error) {
          console.error("Error loading technician:", error);
          alert("Error loading technician data: " + error.message);
        }
      }

      document.getElementById("approveBtn").addEventListener("click", async () => {
        try {
          const technicianDoc = await getDoc(doc(db, "technician", technicianId));

          if (!technicianDoc.exists()) {
            alert("‚ùå Technician not found");
            return;
          }

          const data = technicianDoc.data();

          // Update Firestore first
          await updateDoc(doc(db, "technician", technicianId), {
            status: "Approved",
            updatedAt: new Date().toISOString(),
            updatedBy: "mangotangodev.ph@gmail.com"
          });

          // Secure backend email call
          const response = await fetch("http://localhost:3000/approve-tech", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              email: data.email,
              name: `${data.firstName} ${data.lastName}`
            })
          });

          const result = await response.json();

          if (result.success) {
            alert(`‚úÖ Technician approved!\nüìß Email sent to ${data.email}`);
          } else {
            alert(`‚ö†Ô∏è Approved, but email failed: ${result.error}`);
          }

          window.location.href = "approval.html";

        } catch (error) {
          alert("Error approving technician: " + error.message);
        }
      });

      document.getElementById("rejectBtn").addEventListener("click", async () => {
        try {
          const technicianDoc = await getDoc(doc(db, "technician", technicianId));

          if (!technicianDoc.exists()) {
            alert("‚ùå Technician not found");
            return;
          }

          const data = technicianDoc.data();

          // Ask for a decline reason (optional)
          const reason = prompt("Enter reason for rejection (optional):") || "";

          // Update Firestore
          await updateDoc(doc(db, "technician", technicianId), {
            status: "Rejected",
            updatedAt: new Date().toISOString(),
            updatedBy: "mangotangodev.ph@gmail.com"
          });

          // Secure backend email call
          const response = await fetch("http://localhost:3000/decline-tech", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              email: data.email,
              name: `${data.firstName} ${data.lastName}`,
              reason: reason
            })
          });

          const result = await response.json();

          if (result.success) {
            alert(`‚ùå Technician rejected.\nüìß Rejection email sent to ${data.email}`);
          } else {
            alert(`‚ö†Ô∏è Rejected, but email failed: ${result.error}`);
          }

          window.location.href = "approval.html";

        } catch (error) {
          alert("Error rejecting technician: " + error.message);
        }
      });

      function setupModalEvents() {
        const certificatePreview = document.getElementById("certificatePreview");
        const viewFullScreen = document.getElementById("viewFullScreen");
        const downloadCertificate = document.getElementById("downloadCertificate");
        const certificateModal = document.getElementById("certificateModal");
        const modalCertificateImage = document.getElementById("modalCertificateImage");
        const closeModal = document.getElementById("closeModal");
        const modalClose = document.getElementById("modalClose");
        const modalDownload = document.getElementById("modalDownload");

        function openModal() {
          if (window.currentCertificateUrl && certificateModal && modalCertificateImage) {
            modalCertificateImage.src = window.currentCertificateUrl;
            certificateModal.style.display = "flex";
          }
        }

        function closeModalFunc() {
          if (certificateModal) {
            certificateModal.style.display = "none";
          }
        }

        function downloadCert() {
          if (window.currentCertificateUrl) {
            const link = document.createElement('a');
            link.href = window.currentCertificateUrl;
            link.download = 'certificate.jpg';
            link.click();
          }
        }

        if (certificatePreview) certificatePreview.addEventListener("click", openModal);
        if (viewFullScreen) viewFullScreen.addEventListener("click", openModal);
        if (downloadCertificate) downloadCertificate.addEventListener("click", downloadCert);
        if (closeModal) closeModal.addEventListener("click", closeModalFunc);
        if (modalClose) modalClose.addEventListener("click", closeModalFunc);
        if (modalDownload) modalDownload.addEventListener("click", downloadCert);

        if (certificateModal) {
          certificateModal.addEventListener("click", (e) => {
            if (e.target === certificateModal) {
              closeModalFunc();
            }
          });
        }
      }

      window.addEventListener('DOMContentLoaded', async () => {
        loadTechnician();
        setupModalEvents();
        await initNotifications(db);
      });

      window.addEventListener('popstate', () => {
        if (!auth.currentUser) {
          window.location.replace('admin-login.html');
        }
      });
    </script>
</body>

</html>